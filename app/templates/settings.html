{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h2 class="mb-4"><i class="bi bi-gear-fill me-2"></i>Settings</h2>

      <!-- Appearance Settings -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-palette me-2 text-primary"></i>Appearance
        </div>
        <div class="card-body">
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="darkModeLocal">
            <label class="form-check-label" for="darkModeLocal">Enable dark mode</label>
          </div>

          <div class="mb-3">
            <label for="accentColorLocal" class="form-label">Accent color</label>
            <input type="color" id="accentColorLocal" class="form-control form-control-color"
                   title="Choose your accent color" value="{{ primary_color or '#3a86ff' }}">
          </div>
        </div>
      </div>

      <button id="saveSettings" class="btn btn-primary"><i class="bi bi-save me-1"></i> Save Preferences</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const darkToggleLocal = document.getElementById("darkModeLocal");
  const accentPickerLocal = document.getElementById("accentColorLocal");
  const root = document.documentElement;

  // Load current user preferences
  const theme = localStorage.getItem("theme");
  const accent = localStorage.getItem("accentColor");

  if (theme === "dark") darkToggleLocal.checked = true;
  if (accent) accentPickerLocal.value = accent;

  // Apply accent color live
  function applyAccent(color) {
    root.style.setProperty("--primary-color", color);
    document.querySelectorAll(".btn-primary").forEach(el => el.style.backgroundColor = color);
    document.querySelectorAll(".sidebar a.active").forEach(el => { el.style.borderLeftColor = color; el.style.color = color; });
  }

  accentPickerLocal.addEventListener("input", () => applyAccent(accentPickerLocal.value));
  darkToggleLocal.addEventListener("change", () => {
    if (darkToggleLocal.checked) document.body.classList.add("dark-mode");
    else document.body.classList.remove("dark-mode");
  });

  // Save preferences
  document.getElementById("saveSettings").addEventListener("click", async () => {
    const color = accentPickerLocal.value;
    const themeVal = darkToggleLocal.checked ? "dark" : "light";

    localStorage.setItem("accentColor", color);
    localStorage.setItem("theme", themeVal);

    await fetch("{{ url_for('main.save_settings') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        primary_color: color,
        sidebar_bg_color: root.style.getPropertyValue("--sidebar-bg-light"),
        text_color: root.style.getPropertyValue("--text-dark"),
        theme: themeVal
      })
    });

    const toast = document.createElement("div");
    toast.className = "alert alert-success mt-3";
    toast.innerText = "âœ… Settings saved successfully!";
    document.querySelector(".container-fluid").prepend(toast);
    setTimeout(() => toast.remove(), 2000);
  });
</script>
{% endblock %}
