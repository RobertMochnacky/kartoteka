{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar toggle for small screens -->
    <nav class="navbar navbar-light bg-light d-md-none">
      <div class="container-fluid">
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
          â˜° Menu
        </button>
      </div>
    </nav>

    <!-- Sidebar -->
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3 sidebar-sticky">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}" 
               href="{{ url_for('main.dashboard') }}">
              Dashboard
            </a>
          </li>

          <li class="nav-item">
            <span class="nav-link disabled">Customers</span>
            <ul class="nav flex-column ms-3">
              {% for customer in customers %}
              <li class="nav-item">
                <a class="nav-link {% if request.args.get('customer_id', type=int) == customer.id %}active{% endif %}" 
                   href="{{ url_for('main.view_customer', customer_id=customer.id) }}">
                  {{ customer.name }} ({{ customer.activities|length }})
                </a>
              </li>
              {% endfor %}
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'main.activities' %}active{% endif %}" 
               href="{{ url_for('main.activities') }}">
              Activities
            </a>
          </li>

          <li class="nav-item mt-3">
            <a class="nav-link" href="{{ url_for('auth.logout') }}">
              Logout
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Welcome, {{ current_user.username }}!</h1>
      </div>

      <h3>Customers & Activities</h3>

      {% if customers %}
      <ul class="list-group">
        {% for customer in customers %}
        <li class="list-group-item">
          <strong>{{ customer.name }}</strong> - {{ customer.email }}
          {% if customer.activities %}
          <ul>
            {% for act in customer.activities %}
            <li>
              {{ act.text }}<br>
              <small class="text-muted">
                Added by {{ act.creator.username }} at {{ act.timestamp.strftime('%Y-%m-%d %H:%M') }}
              </small>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p>No activities yet.</p>
          {% endif %}
          <div>
            <a href="{{ url_for('main.edit_customer', customer_id=customer.id) }}">Edit</a> |
            <a href="{{ url_for('main.delete_customer', customer_id=customer.id) }}" onclick="return confirm('Are you sure?');">Delete</a>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No customers yet.</p>
      {% endif %}

      <div class="mt-3">
        <a href="{{ url_for('main.add_customer') }}" class="btn btn-primary">Add New Customer</a>
      </div>

      {% with messages = get_flashed_messages() %}
      {% if messages %}
      <ul class="alert alert-info mt-2">
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% endwith %}
    </main>
  </div>
</div>
{% endblock %}
