{% extends "base.html" %}
{% block title %}{{ _("Activities") }}{% endblock %}

{% block content %}
<h2>{{ _("Activities") }}</h2>

<!-- ========================= -->
<!-- Add New Activity Section -->
<!-- ========================= -->
<div class="card mb-4 rounded-0">
    <div class="card-header rounded-0">
        {{ _("Add New Activity") }}
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('main.add_activity_from_activities') }}" class="row g-3">
            <div class="col-md-4">
                <label for="customer_id_new" class="form-label">{{ _("Customer") }}</label>
                <select name="customer_id" id="customer_id_new" class="form-select rounded-0" required>
                    {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label for="activity_text" class="form-label">{{ _("Activity Text") }}</label>
                <input type="text" name="activity_text" id="activity_text" class="form-control rounded-0" required>
            </div>
            <div class="col-md-2">
                <label for="activity_price" class="form-label">{{ _("Price") }}</label>
                <input type="number" step="0.01" name="price" id="activity_price" class="form-control rounded-0" value="0.0">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100 rounded-0">{{ _("Add") }}</button>
            </div>
        </form>
    </div>
</div>

<!-- ========================= -->
<!-- Filter Activities Section -->
<!-- ========================= -->
<div class="card mb-4 rounded-0">
    <div class="card-header rounded-0">
        {{ _("Filter Activities") }}
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="customer_id" class="form-label">{{ _("Customer") }}</label>
                <select class="form-select rounded-0" name="customer_id" id="customer_id">
                    <option value="">{{ _("All") }}</option>
                    {% for customer in customers %}
                        <option value="{{ customer.id }}" {% if filter_customer_id == customer.id %}selected{% endif %}>
                            {{ customer.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="text" class="form-label">{{ _("Activity Text") }}</label>
                <input type="text" name="text" id="text" class="form-control rounded-0" value="{{ filter_text or '' }}">
            </div>
            <div class="col-md-2">
                <label for="start_date" class="form-label">{{ _("From") }}</label>
                <input type="date" name="start_date" id="start_date" class="form-control rounded-0" value="{{ filter_start_date or '' }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">{{ _("To") }}</label>
                <input type="date" name="end_date" id="end_date" class="form-control rounded-0" value="{{ filter_end_date or '' }}">
            </div>
            <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary w-100 rounded-0">{{ _("Filter") }}</button>
                <a href="{{ url_for('main.activities') }}" class="btn btn-secondary w-100 rounded-0">{{ _("Reset") }}</a>
            </div>
        </form>
    </div>
</div>

<!-- ========================= -->
<!-- Activities List Section -->
<!-- ========================= -->
{% if activities %}
<ul class="list-group rounded-0">
    {% for act in activities %}
    <li class="list-group-item d-flex justify-content-between align-items-center rounded-0" id="activity-{{ act.id }}">
        
        <!-- ========== COLUMN 1: Customer + Activity Text ========== -->
        <div class="flex-grow-1">
            <span class="text-content fw-semibold">
                {{ act.customer.name }} — {{ act.text }}
            </span>

            <!-- Inline Edit Form -->
            <div class="inline-edit-form d-none d-flex gap-2 mt-1 align-items-center">
                <select name="customer_id" class="form-select form-select-sm rounded-0" style="width: 150px;">
                    {% for customer in customers %}
                        <option value="{{ customer.id }}" {% if customer.id == act.customer.id %}selected{% endif %}>{{ customer.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="text" class="form-control form-control-sm rounded-0" value="{{ act.text }}" required>
                <input type="number" step="0.01" name="price" class="form-control form-control-sm rounded-0" value="{{ act.price }}">
                <button type="button" class="btn btn-success btn-sm rounded-0 save-btn" data-id="{{ act.id }}">{{ _("Save") }}</button>
                <button type="button" class="btn btn-secondary btn-sm rounded-0 cancel-btn">{{ _("Cancel") }}</button>
            </div>
        </div>

        <!-- Divider -->
        <span class="mx-3 text-muted">|</span>

        <!-- ========== COLUMN 2: Added By Info ========== -->
        <div class="text-muted small text-end" style="min-width: 220px;">
            {{ _("Added by") }} {{ act.creator.username }} {{ _("at") }} {{ act.timestamp.strftime('%Y-%m-%d %H:%M') }}
        </div>

        <!-- Divider -->
        <span class="mx-3 text-muted">|</span>

        <!-- ========== COLUMN 3: Price ========== -->
        <div class="text-center fw-bold flex-shrink-0"
             style="width: 120px; min-width: 120px;">
            {{ _("Price:") }} {{ "%.2f"|format(act.price or 0.0) }}
        </div>

        <!-- ========== ACTION BUTTONS ========== -->
        <div class="d-flex gap-2 ms-3 flex-shrink-0">
            <button type="button" class="btn btn-outline-primary btn-sm rounded-0 edit-btn">{{ _("Edit") }}</button>
            <a href="{{ url_for('main.delete_activity', activity_id=act.id) }}" 
               class="btn btn-outline-danger btn-sm rounded-0"
               onclick="return confirm('{{ _("Are you sure?") }}');">{{ _("Delete") }}</a>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>{{ _("No activities found.") }}</p>
{% endif %}

<div class="mt-4">
  <a href="{{ url_for('main.export_activities') }}" class="btn btn-primary rounded-0">{{ _("Export Activities") }}</a>
  <a href="{{ url_for('main.import_activities') }}" class="btn btn-secondary rounded-0">{{ _("Import Activities") }}</a>
</div>

<!-- ========================= -->
<!-- Inline Editing JavaScript -->
<!-- ========================= -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".text-content").classList.add("d-none");
            li.querySelector(".inline-edit-form").classList.remove("d-none");
        });
    });

    document.querySelectorAll(".cancel-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".text-content").classList.remove("d-none");
            li.querySelector(".inline-edit-form").classList.add("d-none");
        });
    });

    document.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            const formData = new FormData();
            const customer_id = li.querySelector("select[name='customer_id']").value;
            const text = li.querySelector("input[name='text']").value;
            const price = li.querySelector("input[name='price']").value;
            formData.append("customer_id", customer_id);
            formData.append("text", text);
            formData.append("price", price);

            fetch(`/edit_activity_ajax/${btn.dataset.id}`, {
                method: "POST",
                body: formData,
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      li.querySelector(".text-content").innerHTML =
                          `${data.customer_name} — ${data.text}`;
                      li.querySelector(".text-content").classList.remove("d-none");
                      li.querySelector(".inline-edit-form").classList.add("d-none");
                      li.querySelector(".border-start").textContent = `{{ _("Price:") }} ${parseFloat(data.price).toFixed(2)}`;
                  } else {
                      alert(data.message);
                  }
              });
        });
    });
});
</script>
{% endblock %}
