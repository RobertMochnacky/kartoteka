{% extends "base.html" %}
{% block title %}{{ _("Activities") }}{% endblock %}

{% block content %}
<h2>{{ _("Activities") }}</h2>

<!-- ========================= -->
<!-- Add New Activity Section -->
<!-- ========================= -->
<div class="card mb-4 rounded-0">
    <div class="card-header rounded-0">
        {{ _("Add New Activity") }}
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('main.add_activity_from_activities') }}" class="row g-3">
            <div class="col-md-4">
                <label for="customer_id_new" class="form-label">{{ _("Customer") }}</label>
                <select name="customer_id" id="customer_id_new" class="form-select" required>
                    {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="activity_text" class="form-label">{{ _("Activity Text") }}</label>
                <input type="text" name="activity_text" id="activity_text" class="form-control" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">{{ _("Add Activity") }}</button>
            </div>
        </form>
    </div>
</div>

<!-- ========================= -->
<!-- Filter Activities Section -->
<!-- ========================= -->
<div class="card mb-4 rounded-0">
    <div class="card-header rounded-0">
        {{ _("Filter Activities") }}
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="customer_id" class="form-label">{{ _("Customer") }}</label>
                <select class="form-select" name="customer_id" id="customer_id">
                    <option value="">{{ _("All") }}</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if filter_customer_id == customer.id %}selected{% endif %}>
                        {{ customer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="text" class="form-label">{{ _("Activity Text") }}</label>
                <input type="text" name="text" id="text" class="form-control" value="{{ filter_text or '' }}">
            </div>
            <div class="col-md-2">
                <label for="start_date" class="form-label">{{ _("From") }}</label>
                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ filter_start_date or '' }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">{{ _("To") }}</label>
                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ filter_end_date or '' }}">
            </div>
            <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary w-100">{{ _("Filter") }}</button>
                <a href="{{ url_for('main.activities') }}" class="btn btn-secondary w-100">{{ _("Reset") }}</a>
            </div>
        </form>
    </div>
</div>

<!-- ========================= -->
<!-- Activities List Section -->
<!-- ========================= -->
{% if activities %}
<ul class="list-group rounded-0">
    {% for act in activities %}
    <li class="list-group-item d-flex justify-content-between align-items-center" id="activity-{{ act.id }}">
        <!-- Activity Text -->
        <div class="activity-text flex-grow-1">
            <span class="text-content">
                <strong>{{ act.customer.name }}</strong> - {{ act.text }}
                <br>
                <small class="text-muted">{{ _("Added by") }} {{ act.creator.username }} {{ _("at") }} {{ act.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
            </span>
        </div>

        <!-- Edit/Delete Buttons Separated -->
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm edit-btn">{{ _("Edit") }}</button>
            <a href="{{ url_for('main.delete_activity', activity_id=act.id) }}" 
               class="btn btn-outline-danger btn-sm" onclick="return confirm('{{ _("Are you sure?") }}');">{{ _("Delete") }}</a>
        </div>

        <!-- Inline Edit Form -->
        <div class="inline-edit-form d-none d-flex justify-content-between align-items-center w-100 mt-2">
            <!-- Left side: Customer and Activity Inputs -->
            <div class="d-flex gap-2 flex-grow-1">
                <select name="customer_id" class="form-select form-select-sm" style="width: 150px;">
                    {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if customer.id == act.customer.id %}selected{% endif %}>{{ customer.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="text" class="form-control form-control-sm flex-grow-1" value="{{ act.text }}" required>
            </div>
        
            <!-- Right side: Save/Cancel buttons -->
            <div class="d-flex gap-1 ms-2">
                <button type="button" class="btn btn-success btn-sm save-btn">{{ _("Save") }}</button>
                <button type="button" class="btn btn-secondary btn-sm cancel-btn">{{ _("Cancel") }}</button>
            </div>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>{{ _("No activities found.") }}</p>
{% endif %}

<!-- ========================= -->
<!-- Inline Editing JavaScript -->
<!-- ========================= -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".text-content").classList.add("d-none");
            li.querySelector(".d-flex.gap-2").classList.add("d-none"); // hide edit/delete buttons
            li.querySelector(".inline-edit-form").classList.remove("d-none");
        });
    });

    document.querySelectorAll(".cancel-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".text-content").classList.remove("d-none");
            li.querySelector(".d-flex.gap-2").classList.remove("d-none"); // show edit/delete buttons
            li.querySelector(".inline-edit-form").classList.add("d-none");
        });
    });

    document.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            const formData = new FormData();
            const customer_id = li.querySelector("select[name='customer_id']").value;
            const text = li.querySelector("input[name='text']").value;
            formData.append("customer_id", customer_id);
            formData.append("text", text);

            fetch(`/edit_activity/${btn.dataset.id}`, {
                method: "POST",
                body: formData,
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Error updating activity");
                }
            });
        });
    });
});
</script>

{% endblock %}
