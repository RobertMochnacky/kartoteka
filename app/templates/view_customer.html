{% extends "base.html" %}
{% block title %}{{ customer.name }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Customer Card -->
  <div class="card rounded-0 border-0 shadow-sm">
    <div class="card-header rounded-0" 
         style="background-color: var(--sidebar-bg-light); color: var(--text-dark);">
      <h2 class="mb-0">{{ customer.name }}</h2>
    </div>

    <div class="card-body rounded-0">
      <p>
        <strong>{{ _("Email") }}:</strong> {{ customer.email }} |
        <strong>{{ _("Phone") }}:</strong> {{ customer.phone }} |
        <strong>{{ _("Address") }}:</strong> {{ customer.address }}
      </p>

      <h4 class="mt-4">{{ _("Activities") }}</h4>
      {% if customer.activities %}
        <ul class="list-group rounded-0">
          {% for act in customer.activities %}
            <li class="list-group-item rounded-0 d-flex justify-content-between align-items-center" id="activity-{{ act.id }}">
              
              <!-- Activity Text -->
              <div class="activity-text flex-grow-1">
                <span class="text-content">
                  {{ act.text }}<br>
                  <small class="text-muted">{{ _("Added by") }} {{ act.creator.username }} {{ _("on") }} {{ act.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                </span>
              </div>

              <!-- Edit/Delete Buttons -->
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm rounded-0 edit-btn">{{ _("Edit") }}</button>
                <a href="{{ url_for('main.delete_activity', activity_id=act.id) }}" 
                   class="btn btn-outline-danger btn-sm rounded-0" onclick="return confirm('{{ _('Are you sure?') }}');">{{ _("Delete") }}</a>
              </div>

              <!-- Inline Edit Form -->
              <div class="inline-edit-form d-none d-flex justify-content-between align-items-center w-100 mt-2">
                <div class="d-flex gap-2 flex-grow-1">
                  <select name="customer_id" class="form-select form-select-sm rounded-0" style="width: 150px;">
                    {% for c in customers %}
                      <option value="{{ c.id }}" {% if c.id == act.customer.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                  </select>
                  <input type="text" name="text" class="form-control form-control-sm flex-grow-1 rounded-0" value="{{ act.text }}" required>
                </div>

                <div class="d-flex gap-1 ms-2">
                  <button type="button" class="btn btn-success btn-sm rounded-0 save-btn" data-id="{{ act.id }}">{{ _("Save") }}</button>
                  <button type="button" class="btn btn-secondary btn-sm rounded-0 cancel-btn">{{ _("Cancel") }}</button>
                </div>
              </div>

            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>{{ _("No activities yet.") }}</p>
      {% endif %}

      <!-- Buttons -->
      <div class="mt-3 d-flex flex-wrap gap-2">
        <a href="{{ url_for('main.add_activity', customer_id=customer.id) }}" 
           class="btn btn-primary rounded-0">{{ _("Add Activity") }}</a>
        <a href="{{ url_for('main.customers') }}" 
           class="btn btn-secondary rounded-0">{{ _("Back to Customers") }}</a>
        <a href="{{ url_for('main.dashboard') }}" 
           class="btn btn-secondary rounded-0">{{ _("Back to Dashboard") }}</a>
      </div>
    </div>
  </div>

</div>

<!-- Inline Editing JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".text-content").classList.add("d-none");
            li.querySelector(".d-flex.gap-2").classList.add("d-none");
            li.querySelector(".inline-edit-form").classList.remove("d-none");
        });
    });

    document.querySelectorAll(".cancel-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".text-content").classList.remove("d-none");
            li.querySelector(".d-flex.gap-2").classList.remove("d-none");
            li.querySelector(".inline-edit-form").classList.add("d-none");
        });
    });

    document.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            const formData = new FormData();
            const customer_id = li.querySelector("select[name='customer_id']").value;
            const text = li.querySelector("input[name='text']").value;
            formData.append("customer_id", customer_id);
            formData.append("text", text);

            fetch(`/edit_activity/${btn.dataset.id}`, {
                method: "POST",
                body: formData,
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("{{ _('Error updating activity') }}");
                }
            });
        });
    });
});
</script>
{% endblock %}
