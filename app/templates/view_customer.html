{% extends "base.html" %}
{% block title %}{{ customer.name }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Customer Card -->
  <div class="card rounded-0 border-0 shadow-sm">
    <div class="card-header rounded-0"
         style="background-color: var(--sidebar-bg-light); color: var(--text-dark);">
      <h2 class="mb-0">{{ customer.name }}</h2>
    </div>

    <div class="card-body rounded-0">
      <p>
        <strong>{{ _("Email") }}:</strong> {{ customer.email }} |
        <strong>{{ _("Phone") }}:</strong> {{ customer.phone }} |
        <strong>{{ _("Address") }}:</strong> {{ customer.address }}
      </p>

      <h4 class="mt-4">{{ _("Activities") }}</h4>
      {% if activities %}
        <ul class="list-group rounded-0">
          {% for act in activities %}
            <li class="list-group-item rounded-0 d-flex flex-column" id="activity-{{ act.id }}">

              <!-- Display Mode -->
              <div class="activity-view d-flex justify-content-between align-items-center w-100">
                <div class="d-flex flex-grow-1 gap-3 align-items-center">

                  <!-- Column 1: Activity Text -->
                  <div class="flex-grow-2">
                    <strong>{{ act.text }}</strong>
                  </div>

                  <!-- Column 2: Added By + Timestamp -->
                  <div class="text-muted flex-grow-1" style="min-width: 180px;">
                    {{ _("Added by") }} {{ act.creator.username }}<br>
                    <small>{{ act.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                  </div>

                  <!-- Column 3: Price -->
                  <div class="text-end flex-grow-0" style="min-width: 100px;">
                    {{ _("Price") }}: {{ act.price | round(2) }} â‚¬
                  </div>
                </div>

                <!-- Edit/Delete Buttons -->
                <div class="d-flex gap-2 ms-3">
                  <button type="button" class="btn btn-outline-primary btn-sm rounded-0 edit-btn">{{ _("Edit") }}</button>
                  <a href="{{ url_for('main.delete_activity', activity_id=act.id) }}"
                     class="btn btn-outline-danger btn-sm rounded-0"
                     onclick="return confirm('{{ _('Are you sure?') }}');">{{ _("Delete") }}</a>
                </div>
              </div>

              <!-- Inline Edit Mode -->
              <div class="inline-edit-form d-none d-flex flex-wrap justify-content-between align-items-center w-100 mt-2">
                <div class="d-flex flex-grow-1 gap-3 align-items-center">
                  <!-- Edit Customer -->
                  <select name="customer_id" class="form-select form-select-sm rounded-0" style="width: 150px;">
                    {% for c in customers %}
                      <option value="{{ c.id }}" {% if c.id == act.customer.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                  </select>

                  <!-- Edit Activity Text -->
                  <input type="text" name="text" class="form-control form-control-sm flex-grow-2 rounded-0"
                         value="{{ act.text }}" required>

                  <!-- Edit Price -->
                  <input type="number" step="0.01" name="price" class="form-control form-control-sm flex-grow-0 rounded-0 w-auto"
                         value="{{ act.price | round(2) }}">
                </div>

                <!-- Save / Cancel Buttons -->
                <div class="d-flex gap-1 mt-2 mt-md-0 ms-2">
                  <button type="button" class="btn btn-success btn-sm rounded-0 save-btn" data-id="{{ act.id }}">{{ _("Save") }}</button>
                  <button type="button" class="btn btn-secondary btn-sm rounded-0 cancel-btn">{{ _("Cancel") }}</button>
                </div>
              </div>

            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>{{ _("No activities yet.") }}</p>
      {% endif %}

      <!-- Buttons -->
      <div class="mt-3 d-flex flex-wrap gap-2">
        <a href="{{ url_for('main.add_activity', customer_id=customer.id) }}"
           class="btn btn-primary rounded-0">{{ _("Add Activity") }}</a>
        <a href="{{ url_for('main.customers') }}"
           class="btn btn-secondary rounded-0">{{ _("Back to Customers") }}</a>
        <a href="{{ url_for('main.dashboard') }}"
           class="btn btn-secondary rounded-0">{{ _("Back to Dashboard") }}</a>
      </div>
    </div>
  </div>

</div>

<!-- Inline Editing JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Activate edit mode
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".activity-view").classList.add("d-none");
            li.querySelector(".inline-edit-form").classList.remove("d-none");
        });
    });

    // Cancel edit mode
    document.querySelectorAll(".cancel-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            li.querySelector(".inline-edit-form").classList.add("d-none");
            li.querySelector(".activity-view").classList.remove("d-none");
        });
    });

    // Save activity edit
    document.querySelectorAll(".save-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const li = btn.closest("li");
            const formData = new FormData();
            const customer_id = li.querySelector("select[name='customer_id']").value;
            const text = li.querySelector("input[name='text']").value;
            const price = li.querySelector("input[name='price']").value;
            formData.append("customer_id", customer_id);
            formData.append("text", text);
            formData.append("price", price);

            fetch(`/edit_activity_ajax/${btn.dataset.id}`, {
                method: "POST",
                body: formData,
            }).then(response => response.json())
              .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || "{{ _('Error updating activity') }}");
                }
              })
              .catch(() => alert("{{ _('Error updating activity') }}"));
        });
    });
});
</script>
{% endblock %}
